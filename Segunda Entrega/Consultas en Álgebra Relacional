-- Script de Consultas en Álgebra Relacional de la Base de Datos de la microempresa Pionono Cakes
-- Desarrolladores:
-- Reinaldo Toledo Leguizamón
-- Santiago Hernández Chaparro

-- Proyecto de Bases de Datos 2021-1

use pionono_cakes;

-- 1) JOINS 

-- a) Información del contrato de cada empleado.

π empleado.nombre, empleado.apellido, cargos.nombre, 
salario, contrato.fecha_contratacion, contrato.fecha_terminacion 
(σ cargos.idCargo=contrato.idcargo ∧ empleado.idContrato = contrato.idContrato (empleado ⨝ cargos ⨝ contrato))

-- b)  Empleados y la respectiva sucursal a la que estan vinculados (puede ser más de una)

π empleado.nombre, empleado.apellido, sucursal.nombre 
(σ empleado.idEmpleado=vinculos.idempleado 
∧ sucursal.idsucursal=vinculos.idsucursal(empleado ⨝ sucursal ⨝ vinculos))

-- c) Compras de cada cliente y su respectiva fecha
π cliente.nombre, cliente.apellido, producto.nombre,
venta.fecha   venta_productos 
(σ venta_productos.idventa=venta.idventa ∧ venta.idcliente=cliente.idcliente
∧ producto.idProducto=venta_productos.idProducto (cliente ⨝ producto ⨝ venta))

-- d)Ventas de cada empleado en su respectiva sucursal y fecha

π empleado.nombre, empleado.apellido, sucursal.nombre as sucursal,
venta.fecha (σ venta_productos.idventa=venta.idventa ∧ venta.idempleado=empleado.idempleado ∧ 
producto.idProducto=venta_productos.idProducto ∧ sucursal.idsucursal = venta.idsucursal
(empleado ⨝ producto ⨝ venta ⨝ venta_productos ⨝ sucursal))

-- e) Administradores de las sucursales de la microempresa

π empleado.nombre, empleado.apellido, sucursal.nombre 
(σ cargos.nombre = "Administrador"
∧ empleado.idempleado = sucursal.administrador ∧ contrato.idcargo = cargos.idcargo
∧ empleado.idcontrato = contrato.idcontrato
(empleado ⨝ sucursal ⨝ contrato ⨝ cargos))

-- f) Domiciliarios y sus respectivos teléfonos

π empleado.nombre, empleado.apellido, empleado.telefono 
 (σ cargos.nombre = "Domiciliario"
∧ cargos.idCargo = contrato.idcargo ∧ empleado.idcontrato = contrato.idcontrato
( empleado ⨝ contrato ⨝ cargos))

-- g) Maquinaría, su marca y su respectiva sucursal

π maquinaria_y_equipo.nombre , maquinaria_y_equipo.marca , sucursal.nombre 
(σ maquinaria_y_equipo.idinventario=inventario.idinventario
∧ inventario.idsucursal = sucursal.idsucursal(maquinaria_y_equipo ⨝ sucursal ⨝ inventario))

-- h) Insumos adquiridos con su respectivo proveedor y fecha de compra

π insumo.nombre, proveedor.nombre as provedor, insumo.fecha_de_compra 
(σ insumo.idinsumo=adquisicion_insumos.idinsumo ∧ proveedor.NIT = adquisicion_insumos.NIT(insumo ⨝ proveedor ⨝ adquisicion_insumos))

-- i)Clientes con sus perfiles y sus respectivas direcciones

π cliente.nombre, cliente.apellido, cliente.perfil, domicilio.direccion_entrega 
(σ cliente.idcliente = domicilio.idcliente (cliente ⨝ domicilio))

-- j) Funcionarios de la empresa con su dirección y EPS

π empleado.nombre, empleado.apellido, empleado.direccion, empleado.EPS
(σ cargos.nombre = "Funcionario" ∧ cargos.idCargo = contrato.idcargo ∧ empleado.idcontrato = contrato.idcontrato (empleado ⨝ contrato ⨝ cargos))

-- 2)  Agregaciones y Agrupaciones

-- a) Número de empleados por cada sucursal

select sucursal.nombre as sucursal, count(vinculos.idempleado) from sucursal, vinculos 
where vinculos.idsucursal = sucursal.idsucursal group by sucursal.nombre;

-- b) Promedio salarial de los empleados por sucursal

select sucursal.nombre as sucursal, avg(contrato.salario) from sucursal, vinculos, contrato, empleado
where sucursal.idsucursal = vinculos.idsucursal and contrato.idcontrato = empleado.idempleado
and vinculos.idempleado = empleado.idempleado group by sucursal.nombre;

-- c) Cantidad de maquinaría presente en cada sucursal

select sucursal.nombre as sucursal, count(maquinaria_y_equipo.idmaquinaria_y_equipo) from sucursal, inventario, 
maquinaria_y_equipo where maquinaria_y_equipo.idinventario = inventario.idinventario 
and inventario.idsucursal = sucursal.idsucursal group by sucursal.nombre;

-- d) Deuda de la microempresa referente a insumos 

select sum(precio_por_unidad_de_medida*unidad_de_medida*cantidad) as deuda_insumos 
from insumo where Estado_de_pago = "Pendiente";

-- e) Deuda de la microempresa referente a maquinaría

select sum(Cantidad_a_pagar) as deuda_maquinaria from maquinaria_y_equipo 
where Estado_de_pago = "Pendiente";

-- f) Cantidad de sucursales vinculadas a cada empleado 

select empleado.nombre, empleado.apellido, sum(vinculos.idsucursal) 
from empleado, vinculos where empleado.idempleado = vinculos.idempleado 
group by empleado.nombre and empleado.apellido;

-- g) Cantidad de ventas por cada sucursal

select sucursal.nombre as sucursal, sum(venta.idventa) from venta,sucursal
where sucursal.idsucursal = venta.idsucursal group by sucursal.nombre;

-- h) Cantidad de productos disponibles por categoria

select categoria, sum(idproducto) from producto group by categoria; 

-- i) Salario promedio de todos los empleados

select avg(salario) from contrato;

-- j) Promedio salarial de cada uno de los cargos

select cargos.nombre as cargo, avg(contrato.salario) from cargos, contrato
where cargos.idcargo = contrato.idcargo group by cargos.nombre;

-- 4) IN

-- a) Maquinaria presente en Sopó y bogotá

select maquinaria_y_equipo.nombre, maquinaria_y_equipo.marca from maquinaria_y_equipo, inventario,
sucursal where maquinaria_y_equipo.idinventario=inventario.idinventario and inventario.idsucursal=sucursal.idsucursal
and ciudad in ('Sopó','Bogotá');

-- b) Empleados cuyas EPS son Sanitas, Compensar o Medimas

select nombre, apellido from empleado where EPS in ('Sanitas','Compenar','Medimas');

-- c) Proveedores ubicados en Bogotá, Zipaquirá y Fusagasugá
select nombre as proveedores from proveedor where ubicacion in ('Bogotá','Fusagasugá','Zipaquirá');

-- d) Ventas realizadas entre el 10 de junio al 20 de junio de 2021

select count(idVenta) from venta 
where fecha 
in (
'10-06-2021',
'11-06-2021',
'12-06-2021',
'13-06-2021',
'14-06-2021',
'15-06-2021',
'16-06-2021',
'17-06-2021',
'18-06-2021',
'19-06-2021',
'20-06-2021'
)

-- 5) HAVING

-- a) Promedio salarial de cada sucursal cuando son menores a 10000

select sucursal.nombre as sucursal, avg(contrato.salario) as promedio from sucursal, vinculos, contrato, empleado
where sucursal.idsucursal = vinculos.idsucursal and contrato.idcontrato = empleado.idempleado
and vinculos.idempleado = empleado.idempleado group by sucursal.nombre having promedio < 10000;

-- b) Suma de salarios de las sucursales que son mayores a 30000000

select sucursal.nombre as sucursal, sum(contrato.salario) as total_salarios from sucursal, vinculos, contrato, empleado
where sucursal.idsucursal = vinculos.idsucursal and contrato.idcontrato = empleado.idempleado
and vinculos.idempleado = empleado.idempleado group by sucursal.nombre having total_salarios > 30000000;

-- c) Cantidad de maquinaria sin pagar por sucursal cuando es mayor a 5

select sucursal.nombre as sucursal, sum(maquinaria_y_equipo.idmaquinaria_y_equipo) as cantidad from maquinaria_y_equipo, sucursal,
inventario where maquinaria_y_equipo.idinventario = inventario.idinventario and sucursal.idsucursal = inventario.idsucursal
group by sucursal.nombre having cantidad > 5;
